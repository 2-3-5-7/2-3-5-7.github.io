<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta keywords="编程, 环境搭建, 读书笔记, Galgame, 生活技巧"><title>代码分析 - 自强不息 厚德载物</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="自强不息 厚德载物"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="自强不息 厚德载物"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="1 Call graph  分析函数调用关系图 (call graph) 的几种方法   1.1 静态   1.1.1 Doxygen + Graphviz + Htmlhelp (windows)  - 使用 Doxygen + Graphviz + Htmlhelp，Doxygen 配置，再加上下面两图，不要选生成 Chinese，否则 chm 文件乱码              - 生成前将"><meta property="og:type" content="blog"><meta property="og:title" content="代码分析"><meta property="og:url" content="https://synrst.de/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/3.%20%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7/%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/"><meta property="og:site_name" content="自强不息 厚德载物"><meta property="og:description" content="1 Call graph  分析函数调用关系图 (call graph) 的几种方法   1.1 静态   1.1.1 Doxygen + Graphviz + Htmlhelp (windows)  - 使用 Doxygen + Graphviz + Htmlhelp，Doxygen 配置，再加上下面两图，不要选生成 Chinese，否则 chm 文件乱码              - 生成前将"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://synrst.de/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/3.%20%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7/%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/1.PNG"><meta property="og:image" content="https://synrst.de/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/3.%20%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7/%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/2.PNG"><meta property="article:published_time" content="1970-01-01T00:00:00.000Z"><meta property="article:modified_time" content="2023-05-21T03:21:20.834Z"><meta property="article:author" content="2-3-5-7"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://synrst.de/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/3.%20%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7/%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/1.PNG"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://synrst.de/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/3.%20%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7/%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/"},"headline":"代码分析","image":[],"datePublished":"1970-01-01T00:00:00.000Z","dateModified":"2023-05-21T03:21:20.834Z","author":{"@type":"Person","name":"2-3-5-7"},"publisher":{"@type":"Organization","name":"自强不息 厚德载物","logo":{"@type":"ImageObject","url":"https://synrst.de/img/logo.svg"}},"description":"1 Call graph  分析函数调用关系图 (call graph) 的几种方法   1.1 静态   1.1.1 Doxygen + Graphviz + Htmlhelp (windows)  - 使用 Doxygen + Graphviz + Htmlhelp，Doxygen 配置，再加上下面两图，不要选生成 Chinese，否则 chm 文件乱码              - 生成前将"}</script><link rel="canonical" href="https://synrst.de/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/3.%20%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7/%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-RMG9YTVY9M" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-RMG9YTVY9M');</script><!--!--><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><i class="fa-regular fa-face-grin-squint-tears"></i></a><div class="navbar-item">Mens et Manus</div><a class="navbar-item search" title="搜索 (Ctrl + K)" href="javascript:;"><i class="fas fa-search"></i></a></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><a class="link-muted" href="/categories/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/">虚拟环境</a><span> / </span><a class="link-muted" href="/categories/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/3-%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7/">3. 处理工具</a></span></div></div><h1 class="title is-3 is-size-4-mobile">代码分析</h1><div class="content"><h1 id="1-Call-graph"><a href="#1-Call-graph" class="headerlink" title="1 Call graph"></a>1 Call graph</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/solstice/article/details/488865">分析函数调用关系图 (call graph) 的几种方法</a></p>
<h2 id="1-1-静态"><a href="#1-1-静态" class="headerlink" title="1.1 静态"></a>1.1 静态</h2><h3 id="1-1-1-Doxygen-Graphviz-Htmlhelp-windows"><a href="#1-1-1-Doxygen-Graphviz-Htmlhelp-windows" class="headerlink" title="1.1.1 Doxygen + Graphviz + Htmlhelp (windows)"></a>1.1.1 Doxygen + Graphviz + Htmlhelp (windows)</h3><ul>
<li><p>使用 Doxygen + Graphviz + Htmlhelp，<a target="_blank" rel="noopener" href="https://blog.csdn.net/u010740725/article/details/51387810">Doxygen 配置</a>，再加上下面两图，不要选生成 Chinese，否则 chm 文件乱码</p>
<p>  <img src="/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/3.%20%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7/%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/../%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/1.PNG"></p>
<p>  <img src="/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/3.%20%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7/%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/../%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/2.PNG"></p>
</li>
<li><p>生成前将不用的第三方库代码移走</p>
</li>
<li><p><code>Doxygen error: failed to run html help compiler on index.hhp</code> 报错似乎不影响</p>
</li>
</ul>
<h3 id="1-1-2-SciTools-Understand-windows"><a href="#1-1-2-SciTools-Understand-windows" class="headerlink" title="1.1.2 SciTools Understand (windows)"></a>1.1.2 SciTools Understand (windows)</h3><p><a target="_blank" rel="noopener" href="https://support.scitools.com/t/creating-accurate-c-c-projects/39">C&#x2F;C++ 项目参考</a>， <a target="_blank" rel="noopener" href="https://support.scitools.com/t/buildspy-for-gcc-g-users/40">Buildspy - For gcc&#x2F;g++ Users</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 cygwin 的 /x86_64-w64-mingw32-gcc.exe 编译 openssl</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># buildspy.exe、g++wrapper.exe、gccwrapper.exe 移入上一层目录(\SciTools\bin\pc-win64)，否则找不到 qt 等 dll</span></span><br><span class="line"><span class="comment"># 正常配置好项目</span></span><br><span class="line">./Configure --prefix=/cygdrive/d/Desktop/openssl2/openssl-openssl-3.0.0-alpha9/install mingw64</span><br><span class="line">make clean</span><br><span class="line"><span class="comment"># 为了找到 buildspy 和 wrapper</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/cygdrive/d/MySoftware/SciTools/bin/pc-win64:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"><span class="comment"># 替换编译器</span></span><br><span class="line"><span class="built_in">export</span> CC=gccwrapper</span><br><span class="line">buildspy.exe -db openssl.udb -verbose -cmd make</span><br><span class="line"><span class="comment"># 打开 openssl.udb</span></span><br><span class="line">project -&gt; analyze all files</span><br><span class="line">project -&gt; improve project accuracy -&gt; missing includes 添加 include 文件 C:\cygwin64\usr\x86_64-w64-mingw32\sys-root\mingw\include</span><br></pre></td></tr></table></figure>

<ul>
<li>对于 openssl，一处非常奇怪的宏定义字符串导致编译不过问题，原 Makefile 是 -DOPENSSLDIR&#x3D;”&quot;$(OPENSSLDIR)&quot;，使用 gcc 编译没问题，但使用 gccwrapper 就要改成 -DOPENSSLDIR&#x3D;’ “$(OPENSSLDIR)”‘，注意单引号与双引号间的空格不能省略。在同一行有 3 处都要改。宏定义问题可以通过 gcc 加 -v 参数来调试</li>
</ul>
<h3 id="1-1-3-SciTools-Understand-linux"><a href="#1-1-3-SciTools-Understand-linux" class="headerlink" title="1.1.3 SciTools Understand (linux)"></a>1.1.3 SciTools Understand (linux)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以 openssl 为例</span></span><br><span class="line">make clean</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/home/zack/code/proj/scitools/bin/linux64/buildspy:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"><span class="comment"># 配置 CC 要在 ./config 之前</span></span><br><span class="line"><span class="built_in">export</span> CC=gccwrapper</span><br><span class="line">./config</span><br><span class="line"><span class="comment"># 正确的话应该看到 buildspy 的打印</span></span><br><span class="line">buildspy -db openssl.udb -verbose -cmd make</span><br><span class="line"><span class="comment"># 打开 openssl.udb</span></span><br><span class="line"><span class="comment"># project -&gt; analyze all files，点击结果的 warning 窗口中的 search for missing includes</span></span><br><span class="line"><span class="comment"># 把 gcc 的查找路径添加进去 echo | gcc -E -Wp,-v -</span></span><br><span class="line"><span class="comment"># 另外手动定义两个宏  __x86_64__ 和 __LP64__ 为了 include 64位的头文件 &lt;gnu/stubs-64.h&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-1-4-Sourcetrail"><a href="#1-1-4-Sourcetrail" class="headerlink" title="1.1.4 Sourcetrail"></a>1.1.4 Sourcetrail</h3><p>用 compilation databases 新建项目</p>
<ul>
<li>linux 下用 bear 生成</li>
<li>全平台使用 cmake 生成，<code>set(CMAKE_EXPORT_COMPILE_COMMANDS ON)</code></li>
</ul>
<p>参考这两个<br><a target="_blank" rel="noopener" href="https://aul12.me/embedded/2019/05/27/cubemx-cmake.html">https://aul12.me/embedded/2019/05/27/cubemx-cmake.html</a><br><a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/JSONCompilationDatabase.html">https://clang.llvm.org/docs/JSONCompilationDatabase.html</a></p>
<ul>
<li>stm32 工程使用 cmake，从而生成 compilation databases</li>
<li>使用 stm32 官方 ide</li>
</ul>
<h2 id="1-2-动态"><a href="#1-2-动态" class="headerlink" title="1.2 动态"></a>1.2 动态</h2><h3 id="1-2-1-KcacheGrind-linux"><a href="#1-2-1-KcacheGrind-linux" class="headerlink" title="1.2.1 KcacheGrind (linux)"></a>1.2.1 KcacheGrind (linux)</h3><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/517589/tools-to-get-a-pictorial-function-call-graph-of-code">tools-to-get-a-pictorial-function-call-graph-of-code</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install kcachegrind valgrind</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compile the program as usual, no special flags.</span></span><br><span class="line"><span class="comment"># 这里的调试信息和优化可以参考 工作-&gt;SDK.md 中对 openssl 的调试选项 export CC=&quot;gcc -g3 -ggdb -gdwarf-4 -fno-inline -O0 -fno-omit-frame-pointer&quot;</span></span><br><span class="line">gcc -ggdb3 -O0 -o main -std=c99 main.c</span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate a callgrind.out.&lt;PID&gt; file.</span></span><br><span class="line">valgrind --tool=callgrind ./main arg1 arg2 ...</span><br><span class="line"><span class="comment"># 加参数这种更全，没详细研究</span></span><br><span class="line">valgrind --tool=callgrind --dump-instr=<span class="built_in">yes</span> --collect-jumps=<span class="built_in">yes</span> ./main arg1 arg2 ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># Open a GUI tool to visualize callgrind data.</span></span><br><span class="line">kcachegrind callgrind.out.1234</span><br></pre></td></tr></table></figure>

<ul>
<li>可以查看<strong>最大开销</strong>的调用栈 settings -&gt; sidebars -&gt; call stack ，实际的调用栈猜测是有多条的，还是 gdb 断点看吧</li>
<li>call graph 右键设置好 caller 和 callee depth 后（设小点，防止之后产生的图太大），右键 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/29449548/kcachegrind-how-to-draw-the-full-call-graph">node cost 可以设置为 no minimum</a>，就可以看到所有的 callee 和 caller 了</li>
<li>要看某函数调的所有函数，除了上面改 cost 的方法，还可以看下面第一栏的 Callees</li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/33769323/make-callgrind-show-all-function-calls-in-the-kcachegrind-callgraph">生成整张调用图（很大）的另一个工具</a></li>
<li>右键可以导出成 DOT、png、jpg 文件</li>
</ul>
<h3 id="1-2-2-gcc-instrumental-linux"><a href="#1-2-2-gcc-instrumental-linux" class="headerlink" title="1.2.2 gcc instrumental (linux)"></a>1.2.2 gcc instrumental (linux)</h3><ul>
<li><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/517589/tools-to-get-a-pictorial-function-call-graph-of-code">看 etrace 部分的回答</a> 、<a target="_blank" rel="noopener" href="https://users.suse.com/~krahmer/instrumental/instrumental.pdf">instrumental</a>，这两个程序使用查找 elf 程序中符号“地址”与“名称“ map 的方式生成调用关系，通过调试 instrument 附带的 C 代码发现，linux 上 __cyg_profile_func_enter 传入的函数指针地址与符号表中的不同，<a target="_blank" rel="noopener" href="https://jvns.ca/blog/2018/01/09/resolving-symbol-addresses/">可能的原因 (这篇文章是通过符号名查地址)</a></p>
</li>
<li><p>所以基于 instrumental 的代码改进，使用 <a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/386747/tool-to-print-out-functions-being-called-during-run-time">dladdr</a> 接口获得地址对应的符号名，除了 <code>-finstrument-functions</code>，还要加 <code>-O0 -rdynamic -ldl</code>，不用加 <code>-g</code></p>
</li>
<li><p>类似的还有 <a target="_blank" rel="noopener" href="https://stackoverflow.com/a/351980">backtrace_symbols</a></p>
</li>
<li><p>代码见 instrumental 文件夹，目前还<strong>不支持多线程</strong>，没有锁和分线程统计</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -fPIC -Wall inst.c -o inst.so -ldl</span><br><span class="line">gcc -rdynamic -finstrument-functions -O0 -o code code.c</span><br><span class="line">LD_PRELOAD=/home/inst.so ./code</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以 openssl 为例，openssl 因为有 static 函数，所以效果不太好</span></span><br><span class="line"><span class="built_in">export</span> CC=<span class="string">&quot;gcc -rdynamic -finstrument-functions -O0 &quot;</span></span><br><span class="line">./config</span><br></pre></td></tr></table></figure>
</li>
<li><p>TODO 想支持多线程，把 openssl 的图画出来，把 static 函数批量替换会怎样？可参考 github 上 <a target="_blank" rel="noopener" href="https://github.com/finaldie/ftracer">ftracer</a></p>
</li>
</ul>
<h2 id="1-3-手绘"><a href="#1-3-手绘" class="headerlink" title="1.3 手绘"></a>1.3 手绘</h2><ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/31757959">xmind 的逻辑图</a>，比起 mindmaster 没有节点数目的限制，可以一个文件创建多个画布，免费导出 svg</li>
</ul>
<h1 id="2-内存占用"><a href="#2-内存占用" class="headerlink" title="2 内存占用"></a>2 内存占用</h1><p>valgrind-3.16.1 交叉编译，<a target="_blank" rel="noopener" href="https://blog.csdn.net/sunqian666888/article/details/84454844">参考</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.valgrind.org/info/platforms.html">Supported Platforms</a>，对 kernel 和 glibc 的版本有要求</li>
<li>–prefix 的路径要和最终运行的路径一致</li>
<li>修改 configure  <code>armv7*)</code> 改为 <code>armv7*|arm*)</code></li>
<li>.&#x2F;configure –prefix&#x3D;&#x2F;data&#x2F;update&#x2F;valgrind –host&#x3D;arm-linux-gnueabi , make, make install</li>
<li>精简 lib&#x2F;valgrind 目录下文件 <code>rm callgrind-arm-linux helgrind-arm-linux cachegrind-arm-linux dhat-arm-linux drd-arm-linux lackey-arm-linux exp-bbv-arm-linux</code>，减少占用</li>
<li>要统计的程序使用 -g 编译，-O 优化等级不重要，不会影响堆内存统计</li>
<li>获得最大栈深，根据手册所说栈采样会慢 &#x2F;data&#x2F;update&#x2F;valgrind&#x2F;bin&#x2F;valgrind –tool&#x3D;massif –heap&#x3D;no –stacks&#x3D;yes .&#x2F;sdk 。但这样无法得到最大栈深的调用栈，将线程的栈故意比最大栈深小一些，使用 gdb 调试，得到触发 stackoverflow 的地方。实测，用 ulimit -s 调用栈打不出来</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://valgrind.org/docs/manual/ms-manual.html">valgrind Massif官方文档</a></p>
<p>栈统计的几种方法</p>
<p><a target="_blank" rel="noopener" href="https://www.embedded.com/mastering-stack-and-heap-for-system-reliability-part-2-properly-allocating-stacks/">Properly allocating stacks，这篇文章一共 3 部分</a>、<a target="_blank" rel="noopener" href="https://embeddedgurus.com/stack-overflow/2009/03/computing-your-stack-size/">Computing your stack size</a> ，google ”find max stack depth by stack overflow“ 可以看到 keil 和 IAR 的文章，linux 平台上能想到的办法是改 massif 的源码来记录 detailed snapshot</p>
<h1 id="3-调试"><a href="#3-调试" class="headerlink" title="3 调试"></a>3 调试</h1><h2 id="3-1-gdb"><a href="#3-1-gdb" class="headerlink" title="3.1 gdb"></a>3.1 gdb</h2><p><a target="_blank" rel="noopener" href="https://www.linux.com/news/remote-cross-target-debugging-gdb-and-gdbserver/">https://www.linux.com/news/remote-cross-target-debugging-gdb-and-gdbserver/</a></p>
<p><a target="_blank" rel="noopener" href="https://sourceware.org/gdb/wiki/BuildingCrossGDBandGDBserver%EF%BC%8C%E5%8C%85%E5%90%AB">https://sourceware.org/gdb/wiki/BuildingCrossGDBandGDBserver，包含</a> host、target 解释</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 记得装这个</span></span><br><span class="line">sudo apt-get install texinfo</span><br><span class="line"><span class="comment"># 可以创建不同的 build 文件夹来编译</span></span><br><span class="line"><span class="comment"># gdb &amp; gdbserver</span></span><br><span class="line">../configure --host=mipsel-openwrt-linux --prefix=/home/zack/code/proj/gdb_install</span><br><span class="line"><span class="comment"># gdb</span></span><br><span class="line">../configure --with-expat --target=mipsel-openwrt-linux --prefix=/home/zack/code/proj/gdbonly_install</span><br></pre></td></tr></table></figure>

<h3 id="3-1-1-gdbserver"><a href="#3-1-1-gdbserver" class="headerlink" title="3.1.1 gdbserver"></a>3.1.1 gdbserver</h3><ul>
<li>传入环境变量方法<ul>
<li>sudo gdbserver –wrapper env ‘LD_LIBRARY_PATH&#x3D;&#x2F;lib&#x2F;libpcap&#x2F;lib’ –  :1234 .&#x2F;tiny</li>
</ul>
</li>
</ul>
<h3 id="3-1-2-修改"><a href="#3-1-2-修改" class="headerlink" title="3.1.2 修改"></a>3.1.2 修改</h3><p>为了编译通过做得修改，ubuntu 18.04 环境。基于 master 分支 <code>ee6d95574b 2019-09-04  (HEAD -&gt; master, origin/master, origin/HEAD) Automatic date update in version.in</code></p>
<p><a href="/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/3.%20%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7/%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/../%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/gdb-20190904-ee6d95574b.diff">diff 文件</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拷贝到源码目录，使用 patch </span></span><br><span class="line">patch -p1 &lt;patch.diff</span><br></pre></td></tr></table></figure>



<h3 id="3-1-3-调试"><a href="#3-1-3-调试" class="headerlink" title="3.1.3 调试"></a>3.1.3 调试</h3><p><a target="_blank" rel="noopener" href="https://wizardforcel.gitbooks.io/100-gdb-tips/set-print-pretty-on.html">100 个 gdb技巧</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gdbserver &lt;host-ip&gt;:2345 tinyeye </span><br><span class="line"></span><br><span class="line">./mipsel-openwrt-linux-gdb tinyeye</span><br><span class="line">target remote 192.168.37.1:2345</span><br><span class="line"><span class="built_in">continue</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 每行打印一个结构体成员</span></span><br><span class="line"><span class="built_in">set</span> <span class="built_in">print</span> pretty on</span><br><span class="line">p *(struct list_head *)0x469594</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.cprogramming.com/debugging/segfaults.html">segfaults 常见定位方法</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/2-3-5-7/2-3-5-7.github.io/tree/main/虚拟环境/3. 处理工具/代码分析"><i class="fa-solid fa-download fa-2xl" style="color: gray;"></i></a></p>
</div><!--!--></article></div><!--!--><div class="card"><div class="card-content"><script src="https://giscus.app/client.js" data-repo="2-3-5-7/2-3-5-7.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkzNDMwMjg1MTc=" data-category="General" data-category-id="DIC_kwDOFHIzJc4CWmss" data-mapping="pathname" data-strict="0" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="https://synrst.de/css/light4giscus.css" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async></script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#1-Call-graph"><span class="level-left"><span class="level-item">1 Call graph</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-静态"><span class="level-left"><span class="level-item">1.1 静态</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-1-Doxygen-Graphviz-Htmlhelp-windows"><span class="level-left"><span class="level-item">1.1.1 Doxygen + Graphviz + Htmlhelp (windows)</span></span></a></li><li><a class="level is-mobile" href="#1-1-2-SciTools-Understand-windows"><span class="level-left"><span class="level-item">1.1.2 SciTools Understand (windows)</span></span></a></li><li><a class="level is-mobile" href="#1-1-3-SciTools-Understand-linux"><span class="level-left"><span class="level-item">1.1.3 SciTools Understand (linux)</span></span></a></li><li><a class="level is-mobile" href="#1-1-4-Sourcetrail"><span class="level-left"><span class="level-item">1.1.4 Sourcetrail</span></span></a></li></ul></li><li><a class="level is-mobile" href="#1-2-动态"><span class="level-left"><span class="level-item">1.2 动态</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-2-1-KcacheGrind-linux"><span class="level-left"><span class="level-item">1.2.1 KcacheGrind (linux)</span></span></a></li><li><a class="level is-mobile" href="#1-2-2-gcc-instrumental-linux"><span class="level-left"><span class="level-item">1.2.2 gcc instrumental (linux)</span></span></a></li></ul></li><li><a class="level is-mobile" href="#1-3-手绘"><span class="level-left"><span class="level-item">1.3 手绘</span></span></a></li></ul></li><li><a class="level is-mobile" href="#2-内存占用"><span class="level-left"><span class="level-item">2 内存占用</span></span></a></li><li><a class="level is-mobile" href="#3-调试"><span class="level-left"><span class="level-item">3 调试</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-gdb"><span class="level-left"><span class="level-item">3.1 gdb</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-1-gdbserver"><span class="level-left"><span class="level-item">3.1.1 gdbserver</span></span></a></li><li><a class="level is-mobile" href="#3-1-2-修改"><span class="level-left"><span class="level-item">3.1.2 修改</span></span></a></li><li><a class="level is-mobile" href="#3-1-3-调试"><span class="level-left"><span class="level-item">3.1.3 调试</span></span></a></li></ul></li></ul></li></ul></div></div><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/%E4%B8%93%E4%B8%9A/"><span class="level-start"><span class="level-item">专业</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%88%B1%E5%A5%BD/"><span class="level-start"><span class="level-item">爱好</span></span><span class="level-end"><span class="level-item tag">26</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E7%88%B1%E5%A5%BD/Galgame/"><span class="level-start"><span class="level-item">Galgame</span></span><span class="level-end"><span class="level-item tag">13</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E7%88%B1%E5%A5%BD/Galgame/Ever17/"><span class="level-start"><span class="level-item">Ever17</span></span><span class="level-end"><span class="level-item tag">13</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E7%88%B1%E5%A5%BD/Galgame/Ever17/%E4%BA%BA%E7%89%A9/"><span class="level-start"><span class="level-item">人物</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%88%B1%E5%A5%BD/Galgame/Ever17/%E5%9C%B0%E7%82%B9/"><span class="level-start"><span class="level-item">地点</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%88%B1%E5%A5%BD/Galgame/Ever17/%E5%9C%BA%E6%99%AF/"><span class="level-start"><span class="level-item">场景</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%88%B1%E5%A5%BD/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"><span class="level-start"><span class="level-item">读书笔记</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%89%A9%E7%90%86%E7%8E%AF%E5%A2%83/"><span class="level-start"><span class="level-item">物理环境</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/"><span class="level-start"><span class="level-item">虚拟环境</span></span><span class="level-end"><span class="level-item tag">20</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/1-%E6%9D%A5%E6%BA%90%E4%B8%8E%E6%94%B6%E9%9B%86/"><span class="level-start"><span class="level-item">1. 来源与收集</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/2-%E5%A4%84%E7%90%86%E5%B9%B3%E5%8F%B0/"><span class="level-start"><span class="level-item">2. 处理平台</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/3-%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">3. 处理工具</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/4-%E5%88%86%E4%BA%AB%E4%B8%8E%E5%A4%87%E4%BB%BD/"><span class="level-start"><span class="level-item">4. 分享与备份</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li></ul></div></div></div></div><!--!--></div></div></section><div><button id="toc-btn" onclick="toc.style.display = &#039;block&#039;;toc.onclick = () =&gt; toc.style.display = &#039;none&#039; " style="display: none;"><i class="fa-solid fa-list-ul"></i></button><button id="search-btn" onclick="document.querySelector(&#039;a.navbar-item.search&#039;).click();" style="display: none;"><i class="fa-solid fa-search fa-sm"></i></button></div><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>